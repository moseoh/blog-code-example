---
- name: Restore System to Initial State Using Timeshift
  hosts: all
  become: true
  tasks:
    # Step : Timeshift ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
    - name: Check Timeshift Installation
      block:
        - name: Check Timeshift Installation
          command: which timeshift
          register: timeshift_check
          changed_when: false
          failed_when: false
          ignore_errors: true

        - name: Set Timeshift installation status
          set_fact:
            installed_timeshift: "{{ timeshift_check.rc == 0 }}"

        - name: Fail if Timeshift is not installed
          fail:
            msg: "Timeshift is not installed. Please install it first."
          when: not installed_timeshift

    # Step : ë°±ì—…ë³¸ ëª©ë¡ í™•ì¸
    - name: Check Snapshot List
      block:
        - name: List available Timeshift snapshots
          command: timeshift --list-snapshots
          register: snapshot_list
          changed_when: false
          failed_when: false

        - name: Check snapshot existence
          set_fact:
            has_snapshots: "{{ 'No snapshots found' not in snapshot_list.stdout }}"

        - name: Fail if no snapshots exist
          fail:
            msg: "No snapshots exist"
          when: not has_snapshots

    # Step: ë³µì›
    - name: Restore Snapshot
      block:
        - name: Extract snapshot ID
          set_fact:
            snapshot_lines: "{{ snapshot_list.stdout_lines |
              select('match', '\\d+\\s+>\\s+(\\d{4}-\\d{2}-\\d{2}_\\d{2}-\\d{2}-\\d{2})') |
              map('regex_replace', '^\\d+\\s+>\\s+(\\d{4}-\\d{2}-\\d{2}_\\d{2}-\\d{2}-\\d{2}).*', '\\1') |
              list }}"

        - name: Set latest snapshot if available
          set_fact:
            latest_snapshot: "{{ snapshot_lines[-1] }}"
          when: snapshot_lines | length > 0

        # Step : ë³µì› ì „ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­
        - name: Display restore warning details
          ansible.builtin.pause:
            prompt: |

              ====================================================================
              ğŸš¨                     ì¤‘ìš” ì•ˆë‚´ì‚¬í•­                              ğŸš¨
              ====================================================================

              âš ï¸  ìŠ¤ëƒ…ìƒ· ë³µì› ì‹œ ë‹¤ìŒ ì‚¬í•­ì„ ë°˜ë“œì‹œ í™•ì¸í•´ì£¼ì„¸ìš”:

              1ï¸âƒ£  ë³µì›ë˜ì§€ ì•ŠëŠ” ë””ë ‰í„°ë¦¬/íŒŒì¼
                 ğŸ“ /home          : ì‚¬ìš©ì í™ˆ ë””ë ‰í„°ë¦¬
                 ğŸ“ /tmp           : ì„ì‹œ íŒŒì¼ ë””ë ‰í„°ë¦¬
                 ğŸ“ /proc,/sys,/dev: ì‹œìŠ¤í…œ ë””ë ‰í„°ë¦¬
                 ğŸ“ /run           : ëŸ°íƒ€ì„ ë°ì´í„° ë””ë ‰í„°ë¦¬
                 ğŸ“ /var/run,/lock : í”„ë¡œì„¸ìŠ¤ ë° ë½ íŒŒì¼

              2ï¸âƒ£  ë³µì› í”„ë¡œì„¸ìŠ¤ ì£¼ì˜ì‚¬í•­
                 ğŸ”„ í˜¸ìŠ¤íŠ¸ê°€ ìë™ìœ¼ë¡œ ì¬ì‹œì‘ë©ë‹ˆë‹¤
                 âš ï¸ ë³µì› ì™„ë£ŒëŠ” í˜¸ìŠ¤íŠ¸ ì¬ì‹œì‘ í›„ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤
                 âŒ Ansibleì—ì„œ ìë™ í™•ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤

              ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì…¨ë‹¤ë©´ Enterë¥¼ ëˆŒëŸ¬ ë³µì›ì„ ì‹œì‘í•˜ì„¸ìš”.
              ====================================================================
              Press Enter to continue...

        # Step : ë°±ì—…ë³¸ì„ ì‚¬ìš©í•´ ì‹œìŠ¤í…œ ë³µì›
        - name: Restore system using the latest snapshot
          shell: echo -e "\n" | timeshift --restore --snapshot '{{ latest_snapshot }}' --yes --debug
          register: restore_status
          when: latest_snapshot is defined
