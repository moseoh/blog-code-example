# 쿠키 헤더 테스트 전략

## 문제 개요
- 백엔드에서 설정한 쿠키가 프론트엔드에서 헤더에 제대로 포함되지 않는 경우 발생
- 주요 원인: 도메인 불일치, SameSite 설정, CORS 설정 등

## 테스트 환경 구성
- 프론트엔드: Next.js
- 백엔드: FastAPI
- 테스트 환경: 로컬호스트, 개발 서버(192.168.x.x), 운영 서버(도메인 + SSL)

## 테스트 시나리오 및 순서

### 1. 브라우저에서 백엔드 직접 요청 시나리오
1. **기본 쿠키 설정 테스트**
   - 백엔드에서 기본 쿠키 설정 후 브라우저에서 잘 수신되는지 확인
   - 쿠키 옵션 없이 테스트 (기본값으로 설정)

2. **도메인 설정 테스트**
   - `Domain` 속성을 다양하게 설정하여 테스트
   - 서브도메인 포함/미포함 테스트
   - 잘못된 도메인 설정 시 동작 확인

3. **Path 설정 테스트**
   - `Path` 속성 설정에 따른 쿠키 전송 여부 확인
   - 다양한 경로에서 쿠키 접근성 테스트

4. **SameSite 설정 테스트**
   - `SameSite=None` / `Lax` / `Strict` 설정에 따른 동작 확인
   - 크로스 사이트 요청 시 쿠키 전송 여부 테스트

5. **Secure 플래그 테스트**
   - `Secure` 플래그 설정 시 HTTP/HTTPS 환경에서의 동작 확인
   - 로컬, 개발, 운영 환경별 차이점 확인

6. **HttpOnly 설정 테스트**
   - `HttpOnly` 설정 시 JavaScript에서 쿠키 접근 가능 여부 확인

7. **CORS 설정 테스트**
   - 다양한 `Access-Control-Allow-*` 헤더 설정에 따른 쿠키 전송 여부
   - `Access-Control-Allow-Credentials: true` 설정 중요성 확인
   - 요청 시 `credentials: 'include'` 설정 확인

### 2. 프론트 서버(SSR) 환경에서 백엔드 요청 시나리오
1. **서버 사이드에서 쿠키 전달 테스트**
   - Next.js SSR 환경에서 백엔드로 쿠키 전달 방식 테스트
   - 클라이언트 쿠키를 서버 요청에 포함시키는 방법 확인

2. **쿠키 전달 미들웨어 테스트**
   - Next.js API 라우트나 getServerSideProps에서 쿠키 처리 방식 검증
   - 서버 간 통신에서 쿠키 헤더 설정 방법 확인

3. **인증 토큰 관리 테스트**
   - 세션/인증 쿠키를 서버 사이드에서 관리하는 방법 검증
   - 토큰 갱신 및 만료 처리 메커니즘 테스트

### 3. 환경별 설정 테스트

#### 로컬호스트 환경 (http://localhost)
1. **로컬 개발 환경 설정**
   - localhost 도메인에서의 쿠키 동작 확인
   - 프론트엔드와 백엔드 포트가 다른 경우의 쿠키 공유 테스트
   - CORS 설정 및 Credentials 옵션 확인

2. **개발 편의성 설정**
   - 개발 시 필요한 SameSite, Secure 우회 방법 테스트
   - 개발 환경에 맞는 최적의 쿠키 설정 도출

#### 개발 서버 환경 (192.168.x.x)
1. **IP 기반 쿠키 설정**
   - IP 주소 기반 환경에서의 쿠키 설정 테스트
   - 서브넷 내 통신 시 쿠키 전달 확인

2. **개발 서버 프록시 설정**
   - 개발 서버에서 프록시를 통한 쿠키 전달 테스트
   - Next.js rewrites 또는 프록시 설정 테스트

#### 운영 서버 환경 (도메인 + SSL)
1. **도메인 기반 쿠키 설정**
   - 실제 도메인 환경에서 쿠키 설정 테스트
   - 서브도메인 간 쿠키 공유 테스트
   - www와 non-www 도메인 간 쿠키 공유 확인

2. **SSL 환경 쿠키 설정**
   - HTTPS 환경에서 Secure 플래그 필수 확인
   - 인증서 관련 이슈가 쿠키에 미치는 영향 테스트

3. **프로덕션 보안 설정**
   - 운영 환경에 적합한 SameSite, HttpOnly, Secure 조합 테스트
   - 보안과 사용성 간의 균형점 확인


## 환경별 권장 설정

### 로컬호스트 환경
- Domain: localhost
- SameSite: Lax
- Secure: False (HTTP 허용)
- CORS: 모든 로컬 오리진 허용

### 개발 서버 환경
- Domain: 192.168.x.x 또는 개발 도메인
- SameSite: Lax
- Secure: 상황에 따라 결정 (HTTPS 사용 시 True)
- CORS: 특정 오리진만 허용

### 운영 서버 환경
- Domain: .example.com (서브도메인 포함)
- SameSite: Lax (또는 필요에 따라 None)
- Secure: True (HTTPS 필수)
- HttpOnly: True (보안 쿠키의 경우)
- CORS: 필요한 오리진만 명시적으로 허용

## 문제 해결 방법
- 쿠키가 전송되지 않는 경우:
  1. 브라우저 개발자 도구에서 쿠키 확인
  2. 네트워크 탭에서 요청 헤더 검사
  3. CORS 설정 확인 (`Access-Control-Allow-Credentials`)
  4. 프론트엔드 요청 시 `credentials: 'include'` 설정 확인
  5. 도메인, 경로, SameSite 설정 검토

- 보안 관련 이슈:
  1. HTTPS 환경에서 Secure 플래그 필수
  2. 민감한 정보는 HttpOnly 플래그 사용
  3. 크로스 사이트 요청 필요 시 SameSite=None 및 Secure=True 조합 사용
  4. 최소 권한 원칙에 따라 필요한 경로와 도메인만 설정 